<!DOCTYPE html>
<html>
<head>
    <title>Permission Debug Tool</title>
    <style>
        body { font-family: monospace; margin: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; }
        .primary { background: #007bff; color: white; }
        .success-btn { background: #28a745; color: white; }
        .danger { background: #dc3545; color: white; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 5px; overflow: auto; }
    </style>
</head>
<body>
    <h1>ğŸ”§ Permission Debug Tool</h1>
    
    <div id="status" class="status warning">
        ğŸ“Š Checking current permission status...
    </div>
    
    <h2>Current User Data</h2>
    <pre id="user-data">Loading...</pre>
    
    <h2>Actions</h2>
    <button class="primary" onclick="checkPermissions()">ğŸ” Check Current Permissions</button>
    <button class="success-btn" onclick="syncPermissions()">ğŸ”„ Sync Permissions</button>
    <button class="danger" onclick="clearCache()">ğŸ—‘ï¸ Clear Auth Cache</button>
    
    <h2>Debug Log</h2>
    <pre id="log"></pre>

    <script>
        let logElement = document.getElementById('log');
        let statusElement = document.getElementById('status');
        let userDataElement = document.getElementById('user-data');
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function updateStatus(message, type = 'warning') {
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
        }
        
        async function checkPermissions() {
            log('ğŸ” Checking current permissions...');
            updateStatus('ğŸ” Checking permissions...', 'warning');
            
            try {
                // Check if Clerk is loaded
                if (!window.Clerk) {
                    throw new Error('Clerk not loaded yet');
                }
                
                const user = window.Clerk.user;
                if (!user) {
                    throw new Error('User not signed in');
                }
                
                // Display user data
                const userData = {
                    id: user.id,
                    primaryEmailAddress: user.primaryEmailAddress?.emailAddress,
                    publicMetadata: user.publicMetadata,
                    organizationMemberships: user.organizationMemberships?.length || 0
                };
                
                userDataElement.textContent = JSON.stringify(userData, null, 2);
                
                // Check session claims
                const session = await window.Clerk.session;
                if (session) {
                    log('âœ… Session found');
                    log(`Session ID: ${session.id}`);
                } else {
                    log('âŒ No active session');
                }
                
                // Check metadata
                const metadata = user.publicMetadata;
                if (metadata.role) {
                    log(`ğŸ“‹ Current role: ${metadata.role}`);
                    log(`ğŸ“‹ Allowed roles: ${JSON.stringify(metadata.allowedRoles || [])}`);
                    log(`ğŸ“‹ Excluded permissions: ${metadata.excludedPermissions?.length || 0} items`);
                    log(`ğŸ“‹ Permission hash: ${metadata.permissionHash || 'none'}`);
                    updateStatus(`âœ… Role: ${metadata.role}`, 'success');
                } else {
                    log('âŒ No role found in metadata');
                    updateStatus('âŒ No role in metadata - this is the problem!', 'error');
                }
                
            } catch (error) {
                log(`âŒ Error: ${error.message}`);
                updateStatus(`âŒ Error: ${error.message}`, 'error');
            }
        }
        
        async function syncPermissions() {
            log('ğŸ”„ Syncing permissions...');
            updateStatus('ğŸ”„ Syncing permissions...', 'warning');
            
            try {
                const response = await fetch('/api/sync-current-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(`API Error (${response.status}): ${error}`);
                }
                
                const result = await response.json();
                log('âœ… Permission sync successful!');
                log(`ğŸ“Š Result: ${JSON.stringify(result, null, 2)}`);
                
                updateStatus('âœ… Sync successful - reloading...', 'success');
                
                // Wait a moment then reload
                setTimeout(() => {
                    log('ğŸ”„ Reloading page...');
                    window.location.reload();
                }, 2000);
                
            } catch (error) {
                log(`âŒ Sync failed: ${error.message}`);
                updateStatus(`âŒ Sync failed: ${error.message}`, 'error');
            }
        }
        
        function clearCache() {
            log('ğŸ—‘ï¸ Clearing auth cache...');
            updateStatus('ğŸ—‘ï¸ Clearing cache...', 'warning');
            
            try {
                // Clear localStorage
                Object.keys(localStorage).forEach(key => {
                    if (key.includes('clerk') || key.includes('auth')) {
                        localStorage.removeItem(key);
                        log(`ğŸ—‘ï¸ Removed: ${key}`);
                    }
                });
                
                // Clear sessionStorage
                Object.keys(sessionStorage).forEach(key => {
                    if (key.includes('clerk') || key.includes('auth')) {
                        sessionStorage.removeItem(key);
                        log(`ğŸ—‘ï¸ Removed: ${key}`);
                    }
                });
                
                log('âœ… Cache cleared');
                updateStatus('âœ… Cache cleared - reload manually', 'success');
                
            } catch (error) {
                log(`âŒ Cache clear failed: ${error.message}`);
                updateStatus(`âŒ Cache clear failed: ${error.message}`, 'error');
            }
        }
        
        // Auto-check on load
        window.addEventListener('load', () => {
            setTimeout(checkPermissions, 1000); // Wait for Clerk to load
        });
    </script>
</body>
</html>