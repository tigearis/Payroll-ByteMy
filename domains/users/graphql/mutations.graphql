# Users Domain Mutations
# Security Classification: CRITICAL - Employee PII and authentication data

mutation CreateUser($object: users_insert_input!) {
  insertUser(object: $object) {
    id
    name
    email
    role
    username
    image
    isStaff
    isActive
    managerId
    clerkUserId
  }
}

mutation UpdateUser($id: uuid!, $set: users_set_input!) {
  updateUser(pk_columns: { id: $id }, _set: $set) {
    id
    name
    email
    role
    username
    image
    isStaff
    isActive
    managerId
    clerkUserId
  }
}

mutation DeleteUser($id: uuid!) {
  updateUser(
    pk_columns: { id: $id }
    _set: { isActive: false, deactivatedAt: "now()" }
  ) {
    id
    name
    email
    isActive
    deactivatedAt
  }
}

# Staff mutations (for compatibility with existing code)
mutation UpdateStaff($id: uuid!, $set: users_set_input!) {
  updateUser(pk_columns: { id: $id }, _set: $set) {
    id
    name
    email
    role
    username
    image
    isStaff
    isActive
    managerId
    clerkUserId
  }
}

mutation DeleteStaff($id: uuid!) {
  updateUser(
    pk_columns: { id: $id }
    _set: { isActive: false, deactivatedAt: "now()" }
  ) {
    id
    name
    email
    isActive
    deactivatedAt
  }
}

# API Route Mutations - Migrated from inline GraphQL

mutation UpdateUserRoleFromClerk($clerkId: String!, $role: user_role!) {
  updateUsers(
    where: { clerkUserId: { _eq: $clerkId } }
    _set: { role: $role, updatedAt: "now()" }
  ) {
    affected_rows
    returning {
      id
      name
      email
      role
      clerkUserId
    }
  }
}

mutation CreateUserInDatabase(
  $clerkId: String!
  $name: String!
  $email: String!
  $role: user_role = viewer
  $isStaff: Boolean = false
  $managerId: uuid
  $image: String
) {
  insertUser(
    object: {
      clerkUserId: $clerkId
      name: $name
      email: $email
      role: $role
      isStaff: $isStaff
      managerId: $managerId
      image: $image
    }
    on_conflict: {
      constraint: users_clerk_user_id_key
      update_columns: [name, email, image, updatedAt]
    }
  ) {
    id
    name
    email
    role
    clerkUserId
    isStaff
    managerId
    image
    createdAt
    updatedAt
  }
}
