# Clients Domain Queries
# Security Classification: HIGH - Contains PII and business-critical data
# SOC2 Compliance: Row-level security and audit logging enforced

query GetClients {
  clients(where: { active: { _eq: true } }, orderBy: { name: ASC }) {
    ...ClientBasicInfo
  }
}

# Simple client list for forms and dropdowns (migrated from payrolls/new/page.tsx)
query GetClientsSimple {
  clients {
    id
    name
  }
}

query GetClientsWithContact {
  clients(where: { active: { _eq: true } }, orderBy: { name: ASC }) {
    ...ClientWithContact
  }
}

query ClientsGetClientById($id: uuid!) {
  clientById(id: $id) {
    ...ClientWithRelations
  }
}

query GetClientBasicById($id: uuid!) {
  clientById(id: $id) {
    ...ClientBasicInfo
  }
}

query GetActiveClients {
  clients(where: { active: { _eq: true } }, orderBy: { name: ASC }) {
    ...ClientBasicInfo
  }
}

query GetClientsForBilling {
  clients(where: { active: { _eq: true } }, orderBy: { name: ASC }) {
    ...ClientForBilling
  }
}

query SearchClients($searchTerm: String!) {
  clients(
    where: {
      _and: [
        { active: { _eq: true } }
        {
          _or: [
            { name: { _ilike: $searchTerm } }
            { contactPerson: { _ilike: $searchTerm } }
            { contactEmail: { _ilike: $searchTerm } }
          ]
        }
      ]
    }
    orderBy: { name: ASC }
    limit: 50
  ) {
    ...ClientWithContact
  }
}

# Audit query - limited fields for compliance
query GetClientsForAudit {
  clients(orderBy: { createdAt: DESC }) {
    ...ClientForAudit
  }
}

query GetClientStats {
  clientsAggregate {
    aggregate {
      count
    }
  }
  active_clients: clientsAggregate(where: { active: { _eq: true } }) {
    aggregate {
      count
    }
  }
  inactive_clients: clientsAggregate(where: { active: { _eq: false } }) {
    aggregate {
      count
    }
  }
}

query GetClientsDashboardStats {
  payrollsAggregate(where: {supersededDate: {_isNull: true}}) {
    aggregate {
      count
      sum {
        employeeCount
      }
    }
  }
  clientsAggregate(where: {active: {_eq: true}}) {
    aggregate {
      count
    }
  }
}

# Phase 2: Paginated client queries for performance optimization

query GetClientsPaginated(
  $limit: Int = 20
  $offset: Int = 0
  $where: clientsBoolExp = {}
  $orderBy: [clientsOrderBy!] = [{ name: ASC }]
) {
  clients(
    limit: $limit
    offset: $offset
    where: { _and: [{ active: { _eq: true } }, $where] }
    orderBy: $orderBy
  ) {
    ...ClientListItem
  }

  clientsAggregate(where: { _and: [{ active: { _eq: true } }, $where] }) {
    aggregate {
      count
    }
  }
}

query GetAllClientsPaginated(
  $limit: Int = 20
  $offset: Int = 0
  $where: clientsBoolExp = {}
  $orderBy: [clientsOrderBy!] = [{ name: ASC }]
) {
  clients(limit: $limit, offset: $offset, where: $where, orderBy: $orderBy) {
    ...ClientTableRow
  }

  allClientsAggregate: clientsAggregate(where: $where) {
    aggregate {
      count
    }
  }
}

query SearchClientsPaginated(
  $searchTerm: String!
  $limit: Int = 20
  $offset: Int = 0
) {
  clients(
    where: {
      _and: [
        { active: { _eq: true } }
        {
          _or: [
            { name: { _ilike: $searchTerm } }
            { contactPerson: { _ilike: $searchTerm } }
            { contactEmail: { _ilike: $searchTerm } }
          ]
        }
      ]
    }
    orderBy: { name: ASC }
    limit: $limit
    offset: $offset
  ) {
    ...ClientListItem
  }

  searchAggregate: clientsAggregate(
    where: {
      _and: [
        { active: { _eq: true } }
        {
          _or: [
            { name: { _ilike: $searchTerm } }
            { contactPerson: { _ilike: $searchTerm } }
            { contactEmail: { _ilike: $searchTerm } }
          ]
        }
      ]
    }
  ) {
    aggregate {
      count
    }
  }
}

query GetInactiveClientsPaginated($limit: Int = 20, $offset: Int = 0) {
  clients(
    where: { active: { _eq: false } }
    orderBy: { name: ASC }
    limit: $limit
    offset: $offset
  ) {
    ...ClientTableRow
  }

  inactiveAggregate: clientsAggregate(where: { active: { _eq: false } }) {
    aggregate {
      count
    }
  }
}

# Phase 2: Optimized client queries to reduce over-fetching

query GetClientsQuickList {
  # Minimal client data for dropdowns and quick lists
  clients(where: { active: { _eq: true } }, orderBy: { name: ASC }) {
    ...ClientMinimal
  }
}

query GetClientCard($id: uuid!) {
  # Essential client data for cards and previews
  clientById(id: $id) {
    ...ClientSummary
    contactEmail
    payrollCount: payrollsAggregate(
      where: { supersededDate: { _isNull: true } }
    ) {
      aggregate {
        count
      }
    }
  }
}

# Migrated from app/api/developer/route.ts

query ClientsGetAllForDeveloper {
  clients {
    id
    name
    contactPerson
    contactEmail
    active
  }
}

query GetClientOptions {
  # Ultra-minimal for form options and selectors
  clients(where: { active: { _eq: true } }, orderBy: { name: ASC }) {
    id
    name
  }
}

query GetClientDashboardCards($limit: Int = 12) {
  # Optimized for client dashboard grid
  clients(
    where: { active: { _eq: true } }
    orderBy: { name: ASC }
    limit: $limit
  ) {
    ...ClientDashboardCard
  }
}

query GetClientWithActivePayrolls($id: uuid!) {
  # Client data with only active payroll summary
  clientById(id: $id) {
    ...ClientSummary
    contactEmail
    contactPhone
    contactPerson
    activePayrolls: payrolls(
      where: { supersededDate: { _isNull: true } }
      orderBy: { name: ASC }
    ) {
      id
      name
      status
      primaryConsultant {
        name
      }
    }
  }
}

# Migrated from app/api/developer/route.ts

query GetAllClientsForDeveloper {
  clients {
    id
    name
    contactPerson
    contactEmail
    active
  }
}

query ClientsGetPayrollsData {
  clients(orderBy: { name: ASC }) {
    ...ClientListItem
    payrolls {
      id
      name
      status
      employeeCount
      payrollCycle {
        name
      }
      payrollDateType {
        name
      }
      payrollDates(orderBy: { adjustedEftDate: DESC }, limit: 1) {
        adjustedEftDate
      }
    }
  }
}
