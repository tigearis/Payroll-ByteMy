# Skills Domain Operations for Work Schedule System
# Security Classification: MEDIUM - Skill management and assignment

# User Skills Operations
fragment UserSkillBasic on UserSkills {
  skillName
  proficiencyLevel
  userId
}

fragment UserSkillComplete on UserSkills {
  skillName
  proficiencyLevel
  userId
  user {
    id
    firstName
    lastName
    computedName
    email
    role
  }
}

# Payroll Required Skills Operations
fragment PayrollRequiredSkillBasic on PayrollRequiredSkills {
  skillName
  requiredLevel
  payrollId
}

fragment PayrollRequiredSkillComplete on PayrollRequiredSkills {
  skillName
  requiredLevel
  payrollId
}

# Queries
query GetUserSkills($userId: uuid!) {
  userSkills(where: { userId: { _eq: $userId } }) {
    ...UserSkillBasic
  }
}

query GetUserSkillByCompositeKey($userId: uuid!, $skillName: String!) {
  userSkills(
    where: { 
      _and: [
        { userId: { _eq: $userId } }
        { skillName: { _eq: $skillName } }
      ]
    }
  ) {
    ...UserSkillBasic
  }
}

query GetAllUserSkills {
  userSkills {
    ...UserSkillComplete
  }
}

query GetUsersWithSkills {
  users(where: { isStaff: { _eq: true } }) {
    id
    firstName
    lastName
    computedName
    email
    role
    skills {
      ...UserSkillBasic
    }
  }
}

query GetPayrollRequiredSkills($payrollId: uuid!) {
  payrollRequiredSkills(where: { payrollId: { _eq: $payrollId } }) {
    ...PayrollRequiredSkillBasic
  }
}

query GetPayrollRequiredSkillByCompositeKey($payrollId: uuid!, $skillName: String!) {
  payrollRequiredSkills(
    where: { 
      _and: [
        { payrollId: { _eq: $payrollId } }
        { skillName: { _eq: $skillName } }
      ]
    }
  ) {
    ...PayrollRequiredSkillBasic
  }
}

query GetPayrollsWithRequiredSkills {
  payrolls(where: { supersededDate: { _isNull: true } }) {
    id
    name
    status
    processingTime
    requiredSkills {
      ...PayrollRequiredSkillBasic
    }
  }
}

# Skills matching for assignment
query GetConsultantsWithSkills($requiredSkills: [String!]!) {
  users(
    where: {
      _and: [
        { isStaff: { _eq: true } }
        { isActive: { _eq: true } }
        { role: { _in: ["consultant", "manager", "org_admin"] } }
        { skills: { skillName: { _in: $requiredSkills } } }
      ]
    }
  ) {
    id
    firstName
    lastName
    computedName
    email
    role
    defaultAdminTimePercentage
    skills {
      ...UserSkillBasic
    }
    workSchedules {
      id
      workDay
      workHours
      adminTimeHours
      payrollCapacityHours
      usesDefaultAdminTime
    }
  }
}

# Mutations
mutation CreateUserSkill($skillName: String!, $proficiencyLevel: String!, $userId: uuid!) {
  insertUserSkillsOne(
    object: {
      skillName: $skillName
      proficiencyLevel: $proficiencyLevel
      userId: $userId
    }
  ) {
    ...UserSkillBasic
  }
}

mutation BulkCreateUserSkills($userSkills: [UserSkillsInsertInput!]!) {
  insertUserSkills(objects: $userSkills) {
    returning {
      ...UserSkillBasic
    }
    affectedRows
  }
}

mutation UpdateUserSkill(
  $userId: uuid!
  $skillName: String!
  $proficiencyLevel: String!
) {
  updateUserSkills(
    where: { 
      _and: [
        { userId: { _eq: $userId } }
        { skillName: { _eq: $skillName } }
      ]
    }
    _set: { proficiencyLevel: $proficiencyLevel }
  ) {
    returning {
      ...UserSkillBasic
    }
    affectedRows
  }
}

mutation DeleteUserSkill($userId: uuid!, $skillName: String!) {
  deleteUserSkills(
    where: { 
      _and: [
        { userId: { _eq: $userId } }
        { skillName: { _eq: $skillName } }
      ]
    }
  ) {
    affectedRows
    returning {
      ...UserSkillBasic
    }
  }
}

mutation CreatePayrollRequiredSkill(
  $payrollId: uuid!
  $skillName: String!
  $requiredLevel: String!
) {
  insertPayrollRequiredSkillsOne(
    object: {
      payrollId: $payrollId
      skillName: $skillName
      requiredLevel: $requiredLevel
    }
  ) {
    ...PayrollRequiredSkillBasic
  }
}

mutation BulkCreatePayrollRequiredSkills($skills: [PayrollRequiredSkillsInsertInput!]!) {
  insertPayrollRequiredSkills(objects: $skills) {
    returning {
      ...PayrollRequiredSkillBasic
    }
    affectedRows
  }
}

mutation DeletePayrollRequiredSkill($payrollId: uuid!, $skillName: String!) {
  deletePayrollRequiredSkills(
    where: { 
      _and: [
        { payrollId: { _eq: $payrollId } }
        { skillName: { _eq: $skillName } }
      ]
    }
  ) {
    affectedRows
    returning {
      ...PayrollRequiredSkillBasic
    }
  }
}

# Bulk operations for seeding
mutation BulkDeleteUserSkills($where: UserSkillsBoolExp!) {
  deleteUserSkills(where: $where) {
    affectedRows
  }
}

mutation BulkDeletePayrollRequiredSkills($where: PayrollRequiredSkillsBoolExp!) {
  deletePayrollRequiredSkills(where: $where) {
    affectedRows
  }
}