# Optimized Analytics Queries using Materialized Views
#
# PERFORMANCE OPTIMIZATION: Database-level aggregations
# BEFORE: Client-side processing of 1000+ records with multiple round trips
# AFTER: Pre-computed materialized views with sub-second response times
#
# Expected improvement: 75-90% reduction in query time and data transfer

# ====================================================================
# DAILY ANALYTICS QUERIES (Ultra-Fast)
# ====================================================================

# Daily revenue trends with status breakdown
query GetDailyRevenueTrends(
  $dateFrom: date!
  $dateTo: date!
  $clientId: uuid
  $staffUserId: uuid
) {
  dailyAnalytics: billingAnalyticsDaily(
    where: {
      analyticsDate: { _gte: $dateFrom, _lte: $dateTo }
      clientId: { _eq: $clientId }
      staffUserId: { _eq: $staffUserId }
    }
    orderBy: { analyticsDate: ASC }
  ) {
    analyticsDate
    itemCount
    totalAmount
    totalRevenue
    approvedCount
    pendingCount
    draftCount
    approvedRevenue
    pendingRevenue
    draftRevenue
  }

  # Aggregate summary for the period
  periodSummary: billingAnalyticsDailyAggregate(
    where: {
      analyticsDate: { _gte: $dateFrom, _lte: $dateTo }
      clientId: { _eq: $clientId }
      staffUserId: { _eq: $staffUserId }
    }
  ) {
    aggregate {
      sum {
        itemCount
        totalRevenue
        approvedRevenue
        pendingRevenue
      }
      avg {
        totalAmount
      }
    }
  }
}

# Quick daily analytics summary (for dashboard widgets)
query GetDailyAnalyticsSummary($daysBack: Int = 14) {
  dailyTrends: billingAnalyticsDaily(
    where: {
      analyticsDate: {
        _gte: "date_trunc('day', now() - interval '$daysBack days')"
      }
    }
    orderBy: { analyticsDate: ASC }
  ) {
    analyticsDate
    totalRevenue
    approvedRevenue
    pendingRevenue
    itemCount
    approvedCount
    pendingCount
  }

  # Summary statistics
  summary: billingAnalyticsDailyAggregate(
    where: {
      analyticsDate: {
        _gte: "date_trunc('day', now() - interval '$daysBack days')"
      }
    }
  ) {
    aggregate {
      sum {
        totalRevenue
        approvedRevenue
        pendingRevenue
        itemCount
      }
      avg {
        totalAmount
      }
    }
  }
}

# ====================================================================
# MONTHLY ANALYTICS QUERIES (Comprehensive)
# ====================================================================

# Monthly performance analytics
query GetMonthlyAnalytics(
  $monthsBack: Int = 12
  $clientId: uuid
  $staffUserId: uuid
) {
  monthlyAnalytics: billingAnalyticsMonthly(
    where: {
      analyticsMonth: {
        _gte: "date_trunc('month', now() - interval '$monthsBack months')"
      }
      clientId: { _eq: $clientId }
      staffUserId: { _eq: $staffUserId }
    }
    orderBy: { analyticsMonth: ASC }
  ) {
    analyticsMonth
    itemCount
    uniqueServices
    totalRevenue
    averageAmount
    totalQuantity
    averageHourlyRate
    approvedCount
    pendingCount
    draftCount
    approvedRevenue
    pendingRevenue
    draftRevenue
    approvalRatePercent
  }

  # Year-over-year comparison
  previousPeriodComparison: billingAnalyticsMonthlyAggregate(
    where: {
      analyticsMonth: {
        _gte: "date_trunc('month', now() - interval '${monthsBack * 2} months')"
        _lt: "date_trunc('month', now() - interval '$monthsBack months')"
      }
      clientId: { _eq: $clientId }
      staffUserId: { _eq: $staffUserId }
    }
  ) {
    aggregate {
      sum {
        totalRevenue
        itemCount
      }
      avg {
        approvalRatePercent
      }
    }
  }
}

# ====================================================================
# CLIENT ANALYTICS QUERIES (Business Intelligence)
# ====================================================================

# Client performance analytics
query GetClientAnalytics(
  $limit: Int = 50
  $orderBy: [ClientAnalyticsSummaryOrderBy!] = [{ totalRevenue: DESC }]
  $activeOnly: Boolean = true
) {
  clientAnalytics: clientAnalyticsSummary(
    where: { isActive: { _eq: $activeOnly }, totalBillingItems: { _gt: 0 } }
    limit: $limit
    orderBy: $orderBy
  ) {
    clientId
    clientName
    contactPerson
    contactEmail
    isActive
    totalBillingItems
    totalRevenue
    averageItemValue
    approvedItems
    pendingItems
    draftItems
    approvedRevenue
    pendingRevenue
    draftRevenue
    payrollCount
    activePayrolls
    approvalRatePercent
    activityStatus
    firstBillingItem
    lastBillingItem
  }

  # Client analytics summary
  clientSummary: clientAnalyticsSummaryAggregate(
    where: { isActive: { _eq: $activeOnly }, totalBillingItems: { _gt: 0 } }
  ) {
    aggregate {
      count
      sum {
        totalRevenue
        totalBillingItems
        payrollCount
      }
      avg {
        averageItemValue
        approvalRatePercent
      }
    }
  }
}

# Individual client detailed analytics
query GetClientDetailedAnalytics($clientId: uuid!) {
  client: clientAnalyticsSummary(where: { clientId: { _eq: $clientId } }) {
    clientId
    clientName
    contactPerson
    contactEmail
    isActive
    clientCreatedAt
    totalBillingItems
    totalRevenue
    averageItemValue
    approvedItems
    pendingItems
    draftItems
    approvedRevenue
    pendingRevenue
    draftRevenue
    payrollCount
    activePayrolls
    approvalRatePercent
    activityStatus
    firstBillingItem
    lastBillingItem
  }

  # Client's monthly trends
  clientMonthlyTrends: billingAnalyticsMonthly(
    where: {
      clientId: { _eq: $clientId }
      analyticsMonth: {
        _gte: "date_trunc('month', now() - interval '12 months')"
      }
    }
    orderBy: { analyticsMonth: ASC }
  ) {
    analyticsMonth
    totalRevenue
    itemCount
    approvalRatePercent
  }

  # Client's recent daily activity
  clientDailyActivity: billingAnalyticsDaily(
    where: {
      clientId: { _eq: $clientId }
      analyticsDate: { _gte: "date_trunc('day', now() - interval '30 days')" }
    }
    orderBy: { analyticsDate: DESC }
    limit: 30
  ) {
    analyticsDate
    totalRevenue
    itemCount
    approvedRevenue
    pendingRevenue
  }
}

# ====================================================================
# STAFF ANALYTICS QUERIES (Performance Management)
# ====================================================================

# Staff performance analytics
query GetStaffAnalytics(
  $limit: Int = 20
  $orderBy: [StaffAnalyticsSummaryOrderBy!] = [{ totalRevenue: DESC }]
  $activeOnly: Boolean = true
) {
  staffAnalytics: staffAnalyticsSummary(
    where: { isActive: { _eq: $activeOnly }, totalBillingItems: { _gt: 0 } }
    limit: $limit
    orderBy: $orderBy
  ) {
    staffUserId
    firstName
    lastName
    computedName
    email
    role
    isActive
    totalBillingItems
    totalRevenue
    averageItemValue
    approvedItems
    pendingItems
    approvalRatePercent
    totalHoursLogged
    averageDailyHours
    billableHours
    revenuePerHour
    revenuePerItem
    uniqueClientsServed
    primaryPayrollAssignments
    backupPayrollAssignments
    firstBillingItem
    lastBillingItem
  }

  # Staff performance summary
  staffSummary: staffAnalyticsSummaryAggregate(
    where: { isActive: { _eq: $activeOnly }, totalBillingItems: { _gt: 0 } }
  ) {
    aggregate {
      count
      sum {
        totalRevenue
        totalBillingItems
        totalHoursLogged
      }
      avg {
        revenuePerHour
        approvalRatePercent
      }
    }
  }
}

# Individual staff detailed analytics
query GetStaffDetailedAnalytics($staffUserId: uuid!) {
  staff: staffAnalyticsSummary(where: { staffUserId: { _eq: $staffUserId } }) {
    staffUserId
    firstName
    lastName
    computedName
    email
    role
    isActive
    totalBillingItems
    totalRevenue
    averageItemValue
    approvedItems
    pendingItems
    approvalRatePercent
    totalHoursLogged
    averageDailyHours
    billableHours
    revenuePerHour
    revenuePerItem
    uniqueClientsServed
    primaryPayrollAssignments
    backupPayrollAssignments
    firstBillingItem
    lastBillingItem
    firstTimeEntry
    lastTimeEntry
  }

  # Staff's monthly performance trends
  staffMonthlyTrends: billingAnalyticsMonthly(
    where: {
      staffUserId: { _eq: $staffUserId }
      analyticsMonth: {
        _gte: "date_trunc('month', now() - interval '12 months')"
      }
    }
    orderBy: { analyticsMonth: ASC }
  ) {
    analyticsMonth
    totalRevenue
    itemCount
    approvalRatePercent
    averageHourlyRate
  }
}

# ====================================================================
# SERVICE ANALYTICS QUERIES (Service Performance)
# ====================================================================

# Service performance analytics
query GetServiceAnalytics(
  $limit: Int = 20
  $orderBy: [ServiceAnalyticsSummaryOrderBy!] = [{ totalRevenue: DESC }]
) {
  serviceAnalytics: serviceAnalyticsSummary(limit: $limit, orderBy: $orderBy) {
    serviceName
    totalUsageCount
    uniqueClients
    uniqueStaff
    totalRevenue
    averageRevenuePerUse
    minAmount
    maxAmount
    totalQuantity
    averageQuantity
    averageHourlyRate
    averageUnitPrice
    approvedUsage
    pendingUsage
    approvalRatePercent
    approvedRevenue
    pendingRevenue
    firstUsed
    lastUsed
    usageLast30Days
    usageLast7Days
  }

  # Service analytics summary
  serviceSummary: serviceAnalyticsSummaryAggregate {
    aggregate {
      count
      sum {
        totalRevenue
        totalUsageCount
      }
      avg {
        averageRevenuePerUse
        approvalRatePercent
      }
    }
  }
}

# Service trends and performance insights
query GetServiceTrendsAnalytics($serviceName: String!) {
  service: serviceAnalyticsSummary(
    where: { serviceName: { _eq: $serviceName } }
  ) {
    serviceName
    totalUsageCount
    uniqueClients
    uniqueStaff
    totalRevenue
    averageRevenuePerUse
    approvalRatePercent
    usageLast30Days
    usageLast7Days
  }

  # Service monthly trends
  serviceMonthlyTrends: billingAnalyticsDaily(
    where: {
      serviceName: { _eq: $serviceName }
      analyticsDate: {
        _gte: "date_trunc('month', now() - interval '12 months')"
      }
    }
    orderBy: { analyticsDate: ASC }
  ) {
    analyticsDate
    totalRevenue
    itemCount
    approvedRevenue
    pendingRevenue
  }
}

# ====================================================================
# COMPREHENSIVE DASHBOARD ANALYTICS (All-in-One)
# ====================================================================

# Complete dashboard analytics (replaces multiple separate queries)
query GetComprehensiveDashboardAnalytics(
  $dateFrom: date = "date_trunc('month', now())"
  $dateTo: date = "date_trunc('day', now())"
) {
  # Quick summary metrics
  dashboardSummary: billingAnalyticsDailyAggregate(
    where: { analyticsDate: { _gte: $dateFrom, _lte: $dateTo } }
  ) {
    aggregate {
      sum {
        totalRevenue
        approvedRevenue
        pendingRevenue
        draftRevenue
        itemCount
        approvedCount
        pendingCount
      }
      avg {
        totalAmount
      }
    }
  }

  # Recent daily trends (14 days)
  recentTrends: billingAnalyticsDaily(
    where: {
      analyticsDate: { _gte: "date_trunc('day', now() - interval '14 days')" }
    }
    orderBy: { analyticsDate: ASC }
  ) {
    analyticsDate
    totalRevenue
    approvedRevenue
    pendingRevenue
    itemCount
  }

  # Top clients by revenue (current period)
  topClients: clientAnalyticsSummary(
    where: { isActive: { _eq: true }, totalRevenue: { _gt: 0 } }
    orderBy: { totalRevenue: DESC }
    limit: 10
  ) {
    clientName
    totalRevenue
    totalBillingItems
    approvalRatePercent
    activityStatus
  }

  # Top staff by revenue (current period)
  topStaff: staffAnalyticsSummary(
    where: { isActive: { _eq: true }, totalRevenue: { _gt: 0 } }
    orderBy: { totalRevenue: DESC }
    limit: 10
  ) {
    computedName
    role
    totalRevenue
    revenuePerHour
    approvalRatePercent
    uniqueClientsServed
  }

  # Top services by usage
  topServices: serviceAnalyticsSummary(
    orderBy: { totalRevenue: DESC }
    limit: 10
  ) {
    serviceName
    totalRevenue
    totalUsageCount
    averageRevenuePerUse
    approvalRatePercent
    usageLast30Days
  }
}

# ====================================================================
# SYSTEM PERFORMANCE ANALYTICS
# ====================================================================

# Analytics system health and refresh status
query GetAnalyticsSystemStatus {
  # Latest refresh information
  refreshLog: analyticsRefreshLog(orderBy: { refreshedAt: DESC }, limit: 10) {
    refreshedAt
    refreshDurationSeconds
    refreshError
  }

  # View statistics
  viewStats: information_schema_views(
    where: {
      table_name: { _like: "%analytics%" }
      table_schema: { _eq: "public" }
    }
  ) {
    table_name
    view_definition
  }
}

# Performance comparison metrics
query GetAnalyticsPerformanceMetrics {
  # Materialized view row counts for monitoring
  dailyAnalyticsCount: billingAnalyticsDailyAggregate {
    aggregate {
      count
    }
  }

  monthlyAnalyticsCount: billingAnalyticsMonthlyAggregate {
    aggregate {
      count
    }
  }

  clientAnalyticsCount: clientAnalyticsSummaryAggregate {
    aggregate {
      count
    }
  }

  staffAnalyticsCount: staffAnalyticsSummaryAggregate {
    aggregate {
      count
    }
  }

  serviceAnalyticsCount: serviceAnalyticsSummaryAggregate {
    aggregate {
      count
    }
  }
}

# ====================================================================
# SPECIALIZED REPORTING QUERIES
# ====================================================================

# Financial KPI query (optimized for executive dashboard)
query GetFinancialKPIs(
  $currentPeriodStart: date!
  $previousPeriodStart: date!
  $previousPeriodEnd: date!
) {
  # Current period metrics
  currentPeriod: billingAnalyticsDailyAggregate(
    where: { analyticsDate: { _gte: $currentPeriodStart } }
  ) {
    aggregate {
      sum {
        totalRevenue
        approvedRevenue
        pendingRevenue
        itemCount
      }
    }
  }

  # Previous period for comparison
  previousPeriod: billingAnalyticsDailyAggregate(
    where: {
      analyticsDate: { _gte: $previousPeriodStart, _lte: $previousPeriodEnd }
    }
  ) {
    aggregate {
      sum {
        totalRevenue
        approvedRevenue
        pendingRevenue
        itemCount
      }
    }
  }

  # Active client metrics
  activeClientMetrics: clientAnalyticsSummaryAggregate(
    where: {
      isActive: { _eq: true }
      activityStatus: { _in: ["active", "inactive"] }
    }
  ) {
    aggregate {
      count
      sum {
        totalRevenue
      }
      avg {
        approvalRatePercent
      }
    }
  }
}

# Efficiency analytics (for operational improvements)
query GetEfficiencyAnalytics {
  # Overall approval efficiency
  approvalEfficiency: billingAnalyticsDailyAggregate(
    where: {
      analyticsDate: {
        _gte: "date_trunc('month', now() - interval '3 months')"
      }
    }
  ) {
    aggregate {
      sum {
        approvedCount
        pendingCount
        itemCount
      }
    }
  }

  # Staff efficiency rankings
  staffEfficiency: staffAnalyticsSummary(
    where: { isActive: { _eq: true }, totalBillingItems: { _gt: 10 } }
    orderBy: { revenuePerHour: DESC }
    limit: 15
  ) {
    computedName
    revenuePerHour
    approvalRatePercent
    totalHoursLogged
    totalRevenue
  }

  # Service efficiency metrics
  serviceEfficiency: serviceAnalyticsSummary(
    where: { totalUsageCount: { _gt: 5 } }
    orderBy: { approvalRatePercent: DESC }
    limit: 15
  ) {
    serviceName
    approvalRatePercent
    averageRevenuePerUse
    totalUsageCount
  }
}
