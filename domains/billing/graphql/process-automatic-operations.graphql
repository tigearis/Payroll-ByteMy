# Billing Domain - Process Automatic Operations
# Security Classification: HIGH - Financial operations and billing
# Used by API routes for automatic billing processing

# API ROUTE OPERATIONS - Process Automatic Billing

# Get Tier 1 candidates (completed payroll dates)
query GetTier1CandidatesApi {
  payrollDates(
    where: {
      status: { _eq: "completed" }
      completedAt: { _gte: "now() - interval '7 days'" }
      _not: {
        billingItems: {
          status: { _neq: "draft" }
        }
      }
    }
    limit: 50
    orderBy: { completedAt: DESC }
  ) {
    id
    completedBy
    completedAt
    payrollId
    payroll {
      id
      name
      client {
        id
        name
      }
    }
  }
}

# Get Tier 2 candidates (completed payrolls)
query GetTier2CandidatesApi {
  payrolls(
    where: {
      _and: [
        {
          _not: {
            payrollDates: {
              status: { _neq: "completed" }
            }
          }
        }
        {
          _not: {
            billingItems: {
              payrollDateId: { _isNull: true }
              status: { _neq: "draft" }
            }
          }
        }
        {
          payrollDates: {
            completedAt: { _gte: "now() - interval '30 days'" }
          }
        }
      ]
    }
    limit: 25
    orderBy: { updatedAt: DESC }
  ) {
    id
    name
    primaryConsultantUserId
    client {
      id
      name
    }
  }
}

# Get Tier 3 candidates (monthly billing completion)
query GetTier3CandidatesApi {
  monthlyBillingCompletion(
    where: {
      status: { _eq: "ready_to_bill" }
      tier3BillingGenerated: { _eq: false }
      autoBillingEnabled: { _eq: true }
    }
    limit: 20
    orderBy: [{ billingMonth: DESC }, { billingReadyAt: ASC }]
  ) {
    id
    clientId
    billingMonth
    client {
      id
      name
    }
  }
}

# Log automatic billing event
mutation LogBillingEventApi($input: BillingEventLogInsertInput!) {
  insertBillingEventLogOne(object: $input) {
    id
  }
}

# Get billing candidates counts (GET endpoint)
query GetBillingCandidatesApi {
  # Tier 1 candidates
  tier1Candidates: payrollDatesAggregate(
    where: {
      status: { _eq: "completed" }
      completedAt: { _gte: "now() - interval '7 days'" }
      _not: {
        billingItems: {
          status: { _neq: "draft" }
        }
      }
    }
  ) {
    aggregate {
      count
    }
  }
  
  # Tier 2 candidates
  tier2Candidates: payrollsAggregate(
    where: {
      _and: [
        {
          _not: {
            payrollDates: {
              status: { _neq: "completed" }
            }
          }
        }
        {
          _not: {
            billingItems: {
              payrollDateId: { _isNull: true }
              status: { _neq: "draft" }
            }
          }
        }
        {
          payrollDates: {
            completedAt: { _gte: "now() - interval '30 days'" }
          }
        }
      ]
    }
  ) {
    aggregate {
      count
    }
  }
  
  # Tier 3 candidates
  tier3Candidates: monthlyBillingCompletionAggregate(
    where: {
      status: { _eq: "ready_to_bill" }
      tier3BillingGenerated: { _eq: false }
      autoBillingEnabled: { _eq: true }
    }
  ) {
    aggregate {
      count
    }
  }
}