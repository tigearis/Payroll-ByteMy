# Core Billing Mutations - Enhanced Semi-Automated System

# Time Entry Mutations - Using notes as placeholder 
mutation CreateMultipleTimeEntries($timeEntries: [NotesInsertInput!]!) {
  insertNotes(objects: $timeEntries) {
    returning {
      id
      content
      entityId
      entityType
      createdAt
    }
    affectedRows
  }
}

# Time Entry Mutations - Placeholder (time_entries table not yet implemented)
# mutation CreateMultipleTimeEntries($timeEntries: [timeEntriesInsertInput!]!) {
#   insertTimeEntry(objects: $timeEntries) {
#     returning {
#       id
#       date
#       hours
#       description
#       billableHours
#       rate
#       amount
#       payrollId
#       userId
#     }
#     affectedRows
#   }
# }

# Payroll Billing Generation
mutation GeneratePayrollBilling($billingItem: BillingItemsInsertInput!) {
  insertBillingItemsOne(object: $billingItem) {
    id
    payrollId
    clientId
    totalAmount
    isApproved
    createdAt
  }
}

# Batch Payroll Billing Generation  
mutation CreatePayrollBilling(
  $payrollId: uuid!
  $billingItems: [BillingItemsInsertInput!]!
) {
  # Insert billing items
  billingItems: insertBillingItems(objects: $billingItems) {
    returning {
      id
      payrollId
      clientId
      description
      quantity
      amount
      isApproved
      createdAt
    }
    affectedRows
  }
}

# Create billing item log entry for status changes and tracking
mutation CreateBillingItemLog($input: AuditAuditLogInsertInput!) {
  insertAuditAuditLogOne(object: $input) {
    id
    userId
    action
    success
    metadata
    eventTime
  }
}

# Service Catalog Management
mutation CreateService($input: ServicesInsertInput!) {
  insertServicesOne(object: $input) {
    id
    name
    description
    defaultRate
    billingUnit
    category
    isActive
    currency
    createdAt
    updatedAt
  }
}

mutation UpdateService($id: uuid!, $updates: ServicesSetInput!) {
  updateServicesByPk(pkColumns: { id: $id }, _set: $updates) {
    id
    name
    description
    defaultRate
    billingUnit
    category
    isActive
    currency
    createdAt
    updatedAt
  }
}

mutation DeleteService($id: uuid!) {
  updateServicesByPk(pkColumns: { id: $id }, _set: { isActive: false }) {
    id
    name
    isActive
    updatedAt
  }
}

# Billing Items Management
mutation CreateBillingItem($input: BillingItemsInsertInput!) {
  insertBillingItemsOne(object: $input) {
    ...BillingItemFragment
    client {
      id
      name
    }
    staffUser {
      id
      firstName
      lastName
      computedName
    }
  }
}

mutation UpdateBillingItem($id: uuid!, $updates: BillingItemsSetInput!) {
  updateBillingItemsByPk(pkColumns: { id: $id }, _set: $updates) {
    ...BillingItemFragment
    client {
      id
      name
    }
    staffUser {
      id
      firstName
      lastName
      computedName
    }
  }
}

mutation DeleteBillingItem($id: uuid!) {
  deleteBillingItemsByPk(id: $id) {
    id
    description
  }
}

# Get clients for form dropdown
query GetClientsForBilling {
  clients(
    where: { active: { _eq: true } }
    orderBy: { name: ASC }
  ) {
    id
    name
  }
}

# Time Entries Management
mutation CreateTimeEntry($input: TimeEntriesInsertInput!) {
  insertTimeEntriesOne(object: $input) {
    id
    staffUserId
    clientId
    payrollId
    billingItemId
    workDate
    hoursSpent
    description
    createdAt
    updatedAt
  }
}

mutation UpdateTimeEntry($id: uuid!, $updates: TimeEntriesSetInput!) {
  updateTimeEntriesByPk(pkColumns: { id: $id }, _set: $updates) {
    id
    staffUserId
    clientId
    payrollId
    billingItemId
    workDate
    hoursSpent
    description
    createdAt
    updatedAt
  }
}

# Client Service Agreements Management
mutation BulkUpdateClientServiceAgreements($clientId: uuid!, $agreements: [ClientServiceAgreementsInsertInput!]!) {
  # First delete existing active agreements for this client
  deleteClientServiceAgreements(
    where: { 
      clientId: { _eq: $clientId }
      isActive: { _eq: true }
    }
  ) {
    affectedRows
  }
  
  # Then insert new agreements
  insertClientServiceAgreements(objects: $agreements) {
    returning {
      id
      clientId
      serviceId
      customRate
      billingFrequency
      contractStartDate
      isEnabled
      isActive
      contractStartDate
      contractEndDate
      createdAt
      service {
        id
        name
        description
        defaultRate
        billingUnit
        category
      }
    }
    affectedRows
  }
}

# Payroll Billing Status
mutation UpdatePayrollBillingStatus($payrollId: uuid!, $updates: PayrollsSetInput!) {
  updatePayrollsByPk(
    pkColumns: { id: $payrollId }
    _set: $updates
  ) {
    id
    billingStatus
    estimatedRevenue
    actualRevenue
    profitMargin
    updatedAt
  }
}