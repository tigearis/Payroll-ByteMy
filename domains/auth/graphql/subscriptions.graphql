# Auth Domain Subscriptions
# Security Classification: CRITICAL - Authentication and authorization data
# SOC2 Compliance: Real-time security monitoring with strict access controls

# User authentication status subscriptions
subscription UserAuthStatusUpdates($userId: uuid!) {
  users(where: { id: { _eq: $userId } }) {
    id
    isActive
    role
    updatedAt
    deactivatedAt
    deactivatedBy
  }
}

subscription UserSessionUpdates($clerkUserId: String!) {
  users(where: { clerkUserId: { _eq: $clerkUserId } }) {
    id
    isActive
    role
    updatedAt
    clerkUserId
  }
}

subscription AuthEventsUpdates($userId: uuid!) {
  auditAuthEvents(
    where: { userId: { _eq: $userId } }
    orderBy: { eventTime: DESC }
    limit: 20
  ) {
    id
    eventType
    eventTime
    ipAddress
    userAgent
    success
    failureReason
    userId
  }
}

# Role and permission subscriptions
subscription UserRoleUpdates($userId: uuid!) {
  users(where: { id: { _eq: $userId } }) {
    id
    role
    isStaff
    isActive
    roleAssignments {
      id
      roleId
      role {
        id
        name
        displayName
        priority
        isSystemRole
      }
    }
    updatedAt
  }
}

subscription UserPermissionUpdates($userId: uuid!) {
  users(where: { id: { _eq: $userId } }) {
    id
    role
    roleAssignments {
      roleId
      role {
        name
        rolePermissions {
          id
          permissionId
          conditions
          permission {
            id
            action
            description
            resource {
              name
              displayName
            }
          }
        }
      }
    }
    updatedAt
  }
}

subscription RolePermissionChanges($roleId: uuid!) {
  rolePermissions(where: { roleId: { _eq: $roleId } }) {
    id
    roleId
    permissionId
    conditions
    createdAt
    updatedAt
    permission {
      id
      action
      description
      resource {
        name
        displayName
      }
    }
  }
}

# Security monitoring subscriptions
subscription FailedAuthAttemptsUpdates {
  auditAuthEvents(
    where: { 
      success: { _eq: false }
      eventTime: { _gte: "now() - interval '1 hour'" }
    }
    orderBy: { eventTime: DESC }
  ) {
    id
    eventType
    eventTime
    ipAddress
    userAgent
    failureReason
    userId
  }
}

subscription SuspiciousActivityUpdates {
  auditAuthEvents(
    where: {
      _or: [
        { eventType: { _eq: "multiple_failed_attempts" } }
        { eventType: { _eq: "unusual_location" } }
        { eventType: { _eq: "suspicious_activity" } }
      ]
      eventTime: { _gte: "now() - interval '24 hours'" }
    }
    orderBy: { eventTime: DESC }
  ) {
    id
    eventType
    eventTime
    ipAddress
    userAgent
    userId
    metadata
  }
}

subscription SecurityAlertsUpdates {
  auditAuthEvents(
    where: {
      eventType: { _in: [
        "account_locked",
        "unauthorized_access_attempt",
        "privilege_escalation_attempt",
        "suspicious_activity"
      ] }
      eventTime: { _gte: "now() - interval '1 hour'" }
    }
    orderBy: { eventTime: DESC }
  ) {
    id
    eventType
    eventTime
    ipAddress
    userId
    metadata
  }
}

# Permission audit subscriptions
subscription PermissionChangesUpdates {
  auditPermissionChanges(
    orderBy: { changedAt: DESC }
    limit: 50
  ) {
    id
    changeType
    targetUserId
    changedByUserId
    reason
    oldPermissions
    newPermissions
    changedAt
  }
}

subscription RoleAssignmentUpdates {
  userRoles(orderBy: { createdAt: DESC }) {
    id
    userId
    roleId
    createdAt
    updatedAt
    user {
      id
      firstName
      lastName
      computedName
      email
    }
    role {
      id
      name
      displayName
      priority
    }
  }
}

# System-wide auth monitoring
subscription AuthSystemHealthUpdates {
  auditAuthEvents(
    where: { 
      eventType: { _eq: "login" }
      success: { _eq: true }
      eventTime: { _gte: "now() - interval '1 hour'" }
    }
    orderBy: { eventTime: DESC }
    limit: 10
  ) {
    id
    eventType
    eventTime
    userId
    success
  }
}

subscription ActiveSessionsUpdates {
  auditAuthEvents(
    where: { 
      eventType: { _eq: "session_active" }
      eventTime: { _gte: "now() - interval '30 minutes'" }
    }
    orderBy: { eventTime: DESC }
  ) {
    id
    userId
    eventTime
    ipAddress
  }
}

# User security status subscriptions
subscription UserSecurityStatusUpdates($userId: uuid!) {
  users(where: { id: { _eq: $userId } }) {
    id
    isActive
    role
    updatedAt
  }
}

subscription MFAEventsUpdates($userId: uuid!) {
  auditAuthEvents(
    where: { 
      userId: { _eq: $userId }
      eventType: { _like: "mfa%" }
    }
    orderBy: { eventTime: DESC }
    limit: 10
  ) {
    id
    eventType
    eventTime
    success
    failureReason
    metadata
  }
}

# Admin and compliance subscriptions
subscription UserDeactivationUpdates {
  users(
    where: { 
      isActive: { _eq: false }
      deactivatedAt: { _gte: "now() - interval '24 hours'" }
    }
    orderBy: { deactivatedAt: DESC }
  ) {
    id
    firstName
    lastName
    computedName
    email
    role
    deactivatedAt
    deactivatedBy
    # deactivatedBy is a UUID field, not a relationship
  }
}

subscription PrivilegeChangesUpdates {
  users(
    where: { 
      role: { _in: ["org_admin", "manager", "developer"] }
      updatedAt: { _gte: "now() - interval '1 hour'" }
    }
    orderBy: { updatedAt: DESC }
  ) {
    id
    firstName
    lastName
    computedName
    email
    role
    updatedAt
    roleAssignments {
      role {
        name
        priority
      }
    }
  }
}

# Real-time compliance monitoring
subscription ComplianceEventsUpdates {
  auditPermissionChanges(
    where: { 
      changeType: { _in: [
        "role_assigned", 
        "role_removed", 
        "permission_granted", 
        "permission_revoked",
        "admin_access"
      ] }
      changedAt: { _gte: "now() - interval '1 hour'" }
    }
    orderBy: { changedAt: DESC }
  ) {
    id
    changeType
    targetUserId
    changedByUserId
    reason
    oldPermissions
    newPermissions
    changedAt
  }
}

subscription DataAccessMonitoring($userId: uuid!) {
  auditDataAccessLog(
    where: { 
      userId: { _eq: $userId }
      accessedAt: { _gte: "now() - interval '24 hours'" }
    }
    orderBy: { accessedAt: DESC }
    limit: 100
  ) {
    id
    userId
    resourceType
    resourceId
    accessType
    accessedAt
    ipAddress
    dataClassification
    rowCount
  }
}

# Emergency and incident response subscriptions
subscription SecurityIncidentsUpdates {
  auditAuthEvents(
    where: {
      eventType: { _in: [
        "security_incident",
        "data_breach_attempt",
        "unauthorized_admin_access",
        "multiple_failed_mfa"
      ] }
      eventTime: { _gte: "now() - interval '24 hours'" }
    }
    orderBy: { eventTime: DESC }
  ) {
    id
    eventType
    eventTime
    userId
    ipAddress
    userAgent
    metadata
  }
}

subscription EmergencyAuthUpdates {
  auditAuthEvents(
    where: {
      eventType: { _eq: "emergency_access" }
      eventTime: { _gte: "now() - interval '1 hour'" }
    }
    orderBy: { eventTime: DESC }
  ) {
    id
    eventType
    eventTime
    userId
    ipAddress
    metadata
  }
}