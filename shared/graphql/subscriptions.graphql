# Shared Subscriptions
# Common subscriptions used across domains

# Real-time dashboard subscriptions

subscription ClientCountUpdates {
  clientsAggregate(where: { active: { _eq: true } }) {
    aggregate {
      count
    }
  }
}

subscription PayrollCountUpdates {
  payrollsAggregate(where: { supersededDate: { _is_null: true } }) {
    aggregate {
      count
    }
  }
}

subscription UserCountUpdates {
  usersAggregate(where: { isActive: { _eq: true } }) {
    aggregate {
      count
    }
  }
}

subscription RecentPayrollActivity {
  payrolls(
    where: { supersededDate: { _is_null: true } }
    order_by: { updatedAt: desc }
    limit: 5
  ) {
    id
    name
    status
    updatedAt
    client {
      name
    }
  }
}

subscription RecentUserActivity {
  users(
    where: { isActive: { _eq: true } }
    order_by: { updatedAt: desc }
    limit: 3
  ) {
    id
    name
    role
    updatedAt
  }
}

subscription CriticalPayrollNotifications {
  payrolls(
    where: {
      supersededDate: { _is_null: true }
      status: { _in: ["Issue", "Critical"] }
    }
    order_by: { updatedAt: desc }
    limit: 10
  ) {
    id
    name
    status
    client {
      name
    }
    primaryConsultant {
      name
    }
  }
}

subscription UpcomingPayrollsUpdates($fromDate: date!) {
  payrolls(
    where: {
      supersededDate: { _is_null: true }
      payrollDates: { adjustedEftDate: { _gte: $fromDate } }
    }
    order_by: { payrollDates_aggregate: { min: { adjustedEftDate: asc } } }
    limit: 5
  ) {
    id
    name
    status
    client {
      name
    }
    nextDate: payrollDates(
      where: { adjustedEftDate: { _gte: $fromDate } }
      order_by: { adjustedEftDate: asc }
      limit: 1
    ) {
      adjustedEftDate
    }
  }
}
